import { Trip, Settlement, Person } from '../types';
import { formatAmount } from './currency';

export interface ShareOptions {
  language: 'zh-TW' | 'en';
}

export const generateSettlementMessage = (
  trip: Trip,
  settlements: Settlement[],
  options: ShareOptions
): string => {
  const { language } = options;
  const isZh = language === 'zh-TW';
  
  // Calculate total expenses
  const totalExpenses = trip.expenses.reduce((sum, expense) => sum + expense.amount, 0);
  
  // Build message
  const lines: string[] = [];
  
  // Header
  lines.push(isZh ? 'ğŸ“Š æ—…è¡Œåˆ†å¸³çµæœ' : 'ğŸ“Š Trip Settlement');
  lines.push(isZh ? `è¡Œç¨‹ï¼š${trip.name}` : `Trip: ${trip.name}`);
  lines.push('');
  
  // Participants
  const participantNames = trip.people.map(p => p.name).join(', ');
  lines.push(isZh ? `ğŸ‘¥ åƒèˆ‡è€…: ${participantNames}` : `ğŸ‘¥ Participants: ${participantNames}`);
  
  // Total
  lines.push(isZh ? `ğŸ’° ç¸½èŠ±è²»: ${formatAmount(totalExpenses, trip.currency, language)}` : `ğŸ’° Total Expenses: ${formatAmount(totalExpenses, trip.currency, language)}`);
  
  // Dates
  lines.push(isZh ? `ğŸ“… æ—¥æœŸ: ${trip.startDate} ~ ${trip.endDate}` : `ğŸ“… Dates: ${trip.startDate} ~ ${trip.endDate}`);
  lines.push('');
  
  // Settlement plan
  if (settlements.length > 0) {
    lines.push(isZh ? 'ğŸ’¸ çµç®—æ–¹æ¡ˆ:' : 'ğŸ’¸ Settlement Plan:');
    settlements.forEach(settlement => {
      const fromPerson = trip.people.find(p => p.id === settlement.from);
      const toPerson = trip.people.find(p => p.id === settlement.to);
      if (fromPerson && toPerson) {
        const arrow = isZh ? 'â†’' : 'pays';
        lines.push(`â€¢ ${fromPerson.name} ${arrow} ${toPerson.name}: ${formatAmount(settlement.amount, trip.currency, language)}`);
        
        // Add bank info if available
        if (toPerson.bankInfo) {
          lines.push(`  ${isZh ? 'å¸³æˆ¶' : 'Account'}: ${toPerson.bankInfo.bankName} ${toPerson.bankInfo.accountNumber}`);
        }
      }
    });
  } else {
    lines.push(isZh ? 'âœ… æ‰€æœ‰å¸³ç›®å·²çµæ¸…ï¼' : 'âœ… All settled up!');
  }
  
  lines.push('');
  lines.push(isZh ? 'â° è«‹æ–¼ 7 å¤©å…§å®Œæˆè½‰å¸³ï¼Œè¬è¬ï¼' : 'â° Please settle within 7 days. Thank you!');
  lines.push('');
  lines.push(isZh ? 'ğŸ“± ç”± TravelSplit æ—…è¡Œåˆ†å¸³ç¥å™¨ ç”¢ç”Ÿ' : 'ğŸ“± Generated by TravelSplit');
  
  return lines.join('\n');
};

export const generateReminderMessage = (
  fromPerson: Person,
  toPerson: Person,
  amount: number,
  currency: string,
  tripName: string,
  options: ShareOptions
): string => {
  const { language } = options;
  const isZh = language === 'zh-TW';
  
  const lines: string[] = [];
  
  if (isZh) {
    lines.push(`ğŸ‘‹ å—¨ ${fromPerson.name},`);
    lines.push('');
    lines.push(`é€™æ˜¯ä¸€å€‹å‹å–„çš„æé†’ï¼Œé—œæ–¼ã€Œ${tripName}ã€çš„åˆ†å¸³ï¼š`);
    lines.push('');
    lines.push(`ä½ éœ€è¦ä»˜çµ¦ ${toPerson.name}: ${formatAmount(amount, currency, language)}`);
    
    if (toPerson.bankInfo) {
      lines.push('');
      lines.push('ğŸ¦ è½‰å¸³è³‡è¨Š:');
      lines.push(`éŠ€è¡Œ: ${toPerson.bankInfo.bankName}`);
      lines.push(`å¸³è™Ÿ: ${toPerson.bankInfo.accountNumber}`);
    }
    
    lines.push('');
    lines.push('è¬è¬ï¼ ğŸ˜Š');
  } else {
    lines.push(`ğŸ‘‹ Hi ${fromPerson.name},`);
    lines.push('');
    lines.push(`This is a friendly reminder about "${tripName}" expenses:`);
    lines.push('');
    lines.push(`You need to pay ${toPerson.name}: ${formatAmount(amount, currency, language)}`);
    
    if (toPerson.bankInfo) {
      lines.push('');
      lines.push('ğŸ¦ Transfer Info:');
      lines.push(`Bank: ${toPerson.bankInfo.bankName}`);
      lines.push(`Account: ${toPerson.bankInfo.accountNumber}`);
    }
    
    lines.push('');
    lines.push('Thanks! ğŸ˜Š');
  }
  
  lines.push('');
  lines.push(isZh ? 'ğŸ“± ç”± TravelSplit æ—…è¡Œåˆ†å¸³ç¥å™¨ ç”¢ç”Ÿ' : 'ğŸ“± Generated by TravelSplit');
  
  return lines.join('\n');
};

export const copyToClipboard = async (text: string): Promise<boolean> => {
  try {
    await navigator.clipboard.writeText(text);
    return true;
  } catch (error) {
    // Fallback for older browsers
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    document.body.appendChild(textArea);
    textArea.select();
    try {
      document.execCommand('copy');
      document.body.removeChild(textArea);
      return true;
    } catch (err) {
      document.body.removeChild(textArea);
      return false;
    }
  }
};

export const shareViaLine = (message: string): void => {
  const encodedMessage = encodeURIComponent(message);
  window.open(`https://line.me/R/share?text=${encodedMessage}`, '_blank');
};

export const shareViaWhatsApp = (message: string): void => {
  const encodedMessage = encodeURIComponent(message);
  window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
};

export const shareViaEmail = (subject: string, body: string): void => {
  const encodedSubject = encodeURIComponent(subject);
  const encodedBody = encodeURIComponent(body);
  window.open(`mailto:?subject=${encodedSubject}&body=${encodedBody}`);
};

export const shareViaNative = async (title: string, text: string): Promise<boolean> => {
  if (navigator.share) {
    try {
      await navigator.share({
        title,
        text,
      });
      return true;
    } catch (error) {
      // User cancelled or error occurred
      return false;
    }
  }
  return false;
};
